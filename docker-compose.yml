version: "3.9"

services:
    application:
        build:
            context: .
            dockerfile: docker/app/Dockerfile
        env_file:
            - .env
        volumes:
            - ./storage:/var/www/storage
        networks:
            - app-network
        depends_on:
            - application_database
            - application_redis

    application_server:
        build:
            context: docker/nginx
        ports:
            - "82:82"
        volumes:
            - ./public:/var/www/public
            - ./storage:/var/www/storage
            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
        depends_on:
            - application
        networks:
            - app-network

    application_database:
        image: mysql:8.0
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: architecture_prod
            MYSQL_USER: app
            MYSQL_PASSWORD: secret
        volumes:
            - db_data:/var/lib/mysql
        networks:
            - app-network

    application_redis:
        image: redis:7-alpine
        restart: always
        volumes:
            - redis_data:/data
        networks:
            - app-network

    application_storage:
        image: minio/minio:latest
        restart: always
        environment:
            MINIO_ROOT_USER: minio
            MINIO_ROOT_PASSWORD: minio123
        command: server /data --console-address ":9001"
        ports:
            - "9002:9002"
            - "9003:9003"
        volumes:
            - minio_data:/data
        networks:
            - app-network

networks:
    app-network:

volumes:
    db_data:
    redis_data:
    minio_data:
